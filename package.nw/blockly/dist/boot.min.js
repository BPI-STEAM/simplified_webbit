!function(o,e){"use strict";e.initHandlebars(),Promise.all([new Promise(function(o){o(null)}),e.loadDoc("./views/"+e.PAGE.split("/")[0]+".handlebars").then(function(o){e.renderPage(o.body.innerHTML)}).then(function(){return new Promise(function(o){document.getElementById("simulator-frame").contentWindow.addEventListener("load",function(){o()},!1)})}),e.loadDoc("./toolbox/"+e.PAGE+".xml").then(function(o){let t=[],n=(new XMLSerializer).serializeToString(o.body.firstChild);n.replace(/{{(.*?)}}/g,o=>{t.push(o)}),t.forEach(o=>{let e=o.replace(/{{|}}/g,"");n=n.replace(o,MSG[e])});let i=(new DOMParser).parseFromString(n,"text/xml");e.rawToolbox=e.trimXml(i)}).then(function(){return new Promise(function(t){if("BlocklyStorage"in o&&BlocklyStorage.isLinkUrl()){var n=location.hash.replace("#","");axios.get("/api/projects/linkData?hashid="+n).then(function(n){var i=n.data;return i&&i.errCode&&401===i.errCode?(swal({icon:"warning",title:MSG.loadProjectFailed,text:MSG.loginToReadLink,buttons:[MSG.cancel,MSG.loginPlatform]}).then(function(e){e&&o.open("https://id.webduino.io")}),t()):i&&i.errCode&&423===i.errCode?(swal({icon:"warning",title:MSG.linkExpired}),t()):(e.loadedData=i||null,void t(e.loadedData))}).catch(function(o){console.error("load project failed!",o.message),t()})}else t()})}).then(function(o){return o&&o.customBlocks}).then(function(o){var t=[],n=JSON.parse(localStorage.getItem("customBlocks"));return n&&(t=t.concat(n)),o&&(t=t.concat(o)),e.LOADER_CONFIG=t.filter(function(o,e,t){return t.indexOf(o)===e}),Promise.all(e.LOADER_CONFIG.map(function(o){return e.loadBlockDefs(o)})).then(function(o){return localStorage.setItem("customBlocks",JSON.stringify(t)),o})}).then(function(o){o.forEach(function(o){e.addToolbox(o.category,o.toolboxXml)})}),new Promise(function(e){o.addEventListener("load",function(){e()},!1)})]).then(async function(t){e.setUser(t[0]),e.updateTitle(t[0]),e.customTab.init(),e.init(e.getToolBox()),e.loadDemoArea(),e.loadSimulator(),e.loadGa(t[0]),e.ga(),e.importPrettify(),e.bindHotkey(o.document),e.checkDeviceOnline(),e.popWindow(),e.loadSample(),await e.addCustomBlocks(),e.addExtension(),e.loadJs("dist/lib/clipboard.min.js",function(){e.copyCode()}),e.loadJs("dist/lib/babel.min.js"),e.loadJs("dist/lib/saveSvgAsPng.min.js"),e.loadJs("dist/demoArea-resize.min.js"),e.loadJs("dist/demoArea-dnd.min.js"),e.loadJs("dist/simulator-resize.min.js"),e.loadJs("dist/simulator-dnd.min.js"),e.loadedData&&e.loadedData.simulator&&e.simulator.update(e.loadedData.simulator),chromeVersion.isValid()||swal({text:MSG.updateChrome,icon:"info"})}).catch(function(e){console.error(e),401!==e.status&&404!==e.status||(o.addEventListener("unload",function(){o.localStorage.clear()},!1),BlocklyStorage.alert("專案不存在或自訂積木載入發生問題!","error").then(function(o){location.href="/blockly"}))})}(window,window.Code);